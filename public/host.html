<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz - Host</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;900&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(180deg, #0a1628 0%, #1a2a4a 50%, #0a1628 100%);
      min-height: 100vh;
      color: #fff;
    }

    /* Grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(50, 100, 180, 0.15) 1px, transparent 1px),
        linear-gradient(90deg, rgba(50, 100, 180, 0.15) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h1 {
      text-align: center;
      font-size: 3rem;
      margin-bottom: 30px;
      color: #ffd700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      font-weight: 900;
    }

    .card {
      background: rgba(10, 22, 40, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
    }

    .hidden {
      display: none !important;
    }

    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 20px 24px;
      font-size: 1.2rem;
      font-weight: 900;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      font-family: 'Montserrat', sans-serif;
      margin-top: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .btn-primary {
      background: linear-gradient(180deg, #ffd700 0%, #c9a800 100%);
      color: #8b0000;
      border: 1px solid #ffd700;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    /* Lobby */
    #qr-container {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: fit-content;
      margin: 0 auto 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }

    .pin-display {
      font-size: 5rem;
      font-weight: 900;
      text-align: center;
      letter-spacing: 12px;
      color: #fff;
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
      margin: 15px 0;
    }

    .players-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin: 25px 0;
    }

    .player-tag {
      background: linear-gradient(180deg, #2a5a9a 0%, #1a3a6a 100%);
      border: 2px solid #5aafff;
      color: #fff;
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: 700;
      font-size: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .kick-btn {
      background: #c41e3a;
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      cursor: pointer;
      font-weight: bold;
      opacity: 0.8;
      transition: all 0.2s;
    }

    .kick-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    /* Disconnected state */
    .ranking-item.disconnected {
      opacity: 0.6;
      filter: grayscale(0.8);
    }

    /* Question */
    .question-header {
      color: rgba(255, 255, 255, 0.6);
      text-align: center;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.9rem;
    }

    .question-text {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 40px;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* Live Ranking List */
    .live-ranking-container {
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 5px;
    }

    .live-ranking-container::-webkit-scrollbar {
      width: 8px;
    }

    .live-ranking-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .live-ranking-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    .ranking-list {
      list-style: none;
    }

    .ranking-item {
      background: linear-gradient(180deg, #2a5a9a 0%, #1a3a6a 100%);
      border: 3px solid #5aafff;
      border-radius: 14px;
      padding: 18px 25px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    /* Highlight for answered state in live view */
    .ranking-item.answered {
      border-color: #ffd700;
      background: linear-gradient(180deg, #2a5a9a 0%, #1a3a6a 100%);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
    }

    .ranking-item:first-child {
      background: linear-gradient(180deg, #ffd700 0%, #c9a800 100%);
      border-color: #fff;
    }

    .ranking-item:first-child .ranking-name,
    .ranking-item:first-child .ranking-score,
    .ranking-item:first-child .ranking-position {
      color: #8b0000;
    }

    .ranking-position {
      font-weight: 900;
      font-size: 1.8rem;
      width: 50px;
      color: #fff;
    }

    .ranking-name {
      flex: 1;
      font-weight: 700;
      font-size: 1.4rem;
      color: #fff;
    }

    .ranking-score {
      font-weight: 900;
      color: #ffd700;
      font-size: 1.5rem;
    }

    .answered-indicator {
      font-size: 1.5rem;
      margin-left: 10px;
      color: #2ecc71;
      display: none;
    }

    .ranking-item.answered .answered-indicator {
      display: block;
    }
  </style>
</head>

<body>
  <div id="control-panel" style="position:fixed; top:20px; right:20px; z-index:1000; display:none;">
    <button onclick="endSession()"
      style="background:#c41e3a; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.5); font-family:inherit; text-transform:uppercase; font-size:0.9rem;">
      ‚ùå Encerrar Sess√£o
    </button>
  </div>
  <div class="container">
    <h1>Quiz Show</h1>

    <div id="persistent-display-link-container" style="text-align:center; margin-bottom: 20px; display:none;">
      <div style="font-size: 2rem; font-weight: 900; color: #fff; margin-bottom: 10px; letter-spacing: 5px;">
        PIN: <span id="persistent-pin"></span>
      </div>
      <a href="#" id="persistent-display-link" target="_blank"
        style="color:#5aafff; text-decoration:none; font-weight:600; font-size:1.1rem; border:1px solid #5aafff; padding:8px 16px; border-radius:20px; background:rgba(0,0,0,0.3);">
        üñ•Ô∏è Abrir Tela de Proje√ß√£o
      </a>
    </div>

    <div id="setup-screen" class="card">
      <h2 style="text-align:center; color:#ffd700; margin-bottom:30px; text-transform:uppercase;">Iniciar Sess√£o</h2>

      <div style="display:flex; flex-direction:column; gap:20px;">
        <button id="btn-new-game" class="btn btn-primary" style="margin-top:0;">Criar Novo Jogo</button>
        <button id="btn-load-game" class="btn btn-primary"
          style="background:linear-gradient(180deg, #2a5a9a 0%, #1a3a6a 100%); border-color:#5aafff; margin-top:0;">Carregar
          Jogo Salvo</button>
      </div>

      <div id="saves-list-container" class="hidden"
        style="margin-top:30px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
        <h3 style="color:#fff; margin-bottom:15px; font-size:1rem;">Jogos Salvos</h3>
        <ul id="saves-list" style="list-style:none; max-height:300px; overflow-y:auto; padding-right:5px;">
          <!-- Populated via JS -->
        </ul>
      </div>
    </div>

    <!-- Lobby -->
    <div id="lobby" class="card hidden">

      <p style="text-align:center;color:rgba(255,255,255,0.7);margin-bottom:8px;text-transform:uppercase;">PIN da Sala
      </p>
      <div class="pin-display" id="pin"></div>
      <a href="#" id="display-link" target="_blank"
        style="display:block;text-align:center;color:#5aafff;margin:20px 0;font-size:1rem;text-decoration:none;font-weight:600;">Abrir
        tela de proje√ß√£o ‚Üó</a>

      <p
        style="text-align:center;margin:40px 0 15px;color:rgba(255,255,255,0.7);text-transform:uppercase;font-weight:700;">
        Participantes conectados</p>
      <div class="players-list" id="players"></div>

      <button class="btn btn-primary" id="btn-start" disabled>Iniciar Quiz</button>

      <div style="margin-top:40px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
        <h3 style="color:#ffd700; margin-bottom:15px; font-size:1.2rem; text-transform:uppercase; text-align:center;">
          Resumo do Quiz</h3>
        <div id="lobby-questions-list"
          style="max-height:300px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:12px; padding:15px; border:1px solid rgba(255,255,255,0.1);">
          <!-- Populated via JS -->
          <p style="text-align:center; color:#aaa;">Carregando perguntas...</p>
        </div>
      </div>
    </div>

    <!-- Pergunta ativa (Host View) -->
    <div id="question" class="card hidden">
      <!-- Main Layout: Grid for Question/Status + Upcoming -->
      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">

        <!-- Left Column: Active Question -->
        <div>
          <p class="question-header">Pergunta <span id="q-index">1</span> de <span id="q-total">5</span></p>
          <p class="question-text" id="q-text" style="margin-bottom:20px;"></p>

          <h3 style="text-align:center; color:#ffd700; margin-bottom:15px; text-transform:uppercase; font-size:1rem;">
            Status dos Jogadores</h3>
          <div class="live-ranking-container" style="max-height:300px;">
            <ul class="ranking-list" id="live-ranking-list"></ul>
          </div>


        </div>

        <!-- Right Column: Upcoming Questions -->
        <div
          style="background:rgba(0,0,0,0.2); padding:15px; border-radius:12px; border:1px solid rgba(255,255,255,0.1); display:flex; flex-direction:column; max-height: 500px;">
          <h3 style="color:#ffd700; margin-bottom:15px; font-size:1rem; text-transform:uppercase; text-align:center;">
            Pr√≥ximas Perguntas</h3>
          <div id="upcoming-list" style="overflow-y:auto; flex:1; padding-right:5px;">
            <!-- Populated via JS -->
          </div>

          <!-- Force End Button -->
          <button class="btn btn-primary" onclick="forceNext()"
            style="margin-top:20px; background:linear-gradient(180deg, #c41e3a 0%, #8b0000 100%); border-color:#ff6b6b;">
            Encerrar Pergunta
          </button>
        </div>

      </div>
    </div>

    <!-- Ranking Round End -->
    <div id="ranking" class="card hidden">
      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">

        <!-- Left: Ranking -->
        <div>
          <h2 style="text-align:center;margin-bottom:30px;color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,0.5);">
            Ranking da Rodada</h2>
          <ul class="ranking-list" id="ranking-list"></ul>
          <button class="btn btn-primary" id="btn-continue" style="margin-top:30px;">Pr√≥xima Pergunta</button>
        </div>

        <!-- Right: Upcoming -->
        <div
          style="background:rgba(0,0,0,0.2); padding:15px; border-radius:12px; border:1px solid rgba(255,255,255,0.1); display:flex; flex-direction:column; max-height: 500px;">
          <h3 style="color:#ffd700; margin-bottom:15px; font-size:1rem; text-transform:uppercase; text-align:center;">
            Pr√≥ximas Perguntas</h3>
          <div id="upcoming-list-ranking" style="overflow-y:auto; flex:1; padding-right:5px;">
            <!-- Populated via JS -->
          </div>
        </div>

      </div>
    </div>

    <!-- Final -->
    <div id="final" class="card hidden">
      <h2
        style="text-align:center;margin-bottom:40px;font-size:3rem;color:#ffd700;text-shadow:0 0 20px rgba(255,215,0,0.5);">
        Resultado Final</h2>
      <ul class="ranking-list" id="final-ranking"></ul>
    </div>
  </div>

  <script>
    const socket = io();
    let currentPin = '';
    let playersData = [];
    let allQuestions = []; // Store full quiz data

    const $setup = document.getElementById('setup-screen');
    const $lobby = document.getElementById('lobby');
    const $question = document.getElementById('question');
    const $ranking = document.getElementById('ranking');
    const $final = document.getElementById('final');

    // Auto-reconnect on connection (page load or network restore)
    socket.on('connect', () => {
      const savedPin = localStorage.getItem('hostPin');
      if (savedPin) {
        console.log('Attempting to reconnect host with PIN:', savedPin);
        socket.emit('host:reconnect', { pin: savedPin });
      }
    });

    document.getElementById('btn-new-game').onclick = () => {
      socket.emit('host:create');
    };

    document.getElementById('btn-load-game').onclick = () => {
      const list = document.getElementById('saves-list-container');
      if (list.classList.contains('hidden')) {
        socket.emit('host:listSaves');
        list.classList.remove('hidden');
      } else {
        list.classList.add('hidden');
      }
    };

    socket.on('host:savesList', (saves) => {
      const listEl = document.getElementById('saves-list');
      if (saves.length === 0) {
        listEl.innerHTML = '<li style="color:#aaa; text-align:center;">Nenhum jogo salvo encontrado.</li>';
        return;
      }

      listEl.innerHTML = saves.map(s => {
        const date = new Date(s.updatedAt).toLocaleString();
        return `
            <li style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:15px; margin-bottom:10px; cursor:pointer; transition:all 0.2s;" 
                onclick="loadSave('${s.pin}')"
                onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:bold; color:#ffd700; font-size:1.2rem;">PIN: ${s.pin}</span>
                    <span style="font-size:0.8rem; color:#aaa;">${date}</span>
                </div>
                <div style="margin-top:5px; font-size:0.9rem;">
                    Pergunta: ${s.currentQuestion} / ${s.totalQuestions} ‚Ä¢ Jogadores: ${s.playerCount}
                </div>
            </li>
            `;
      }).join('');
    });

    window.loadSave = (pin) => {
      socket.emit('host:loadSave', { pin });
    };

    socket.on('host:error', (msg) => {
      localStorage.removeItem('hostPin');
      // If error on load, maybe stay on setup?
      if (currentPin) { // if we thought we had a pin
        showScreen('setup-screen');
      } else {
        alert(msg);
      }
    });

    function updatePersistentLink(pin) {
      const container = document.getElementById('persistent-display-link-container');
      const link = document.getElementById('persistent-display-link');
      const pinDisplay = document.getElementById('persistent-pin');
      if (pin) {
        link.href = `${window.location.origin}/display.html?pin=${pin}`;
        pinDisplay.textContent = pin;
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }

    socket.on('host:created', ({ pin, allQuestions: qs }) => {
      currentPin = pin;
      allQuestions = qs || [];
      localStorage.setItem('hostPin', pin);
      updatePersistentLink(pin);
      setupLobby(pin);
      showScreen('lobby');
      document.getElementById('control-panel').style.display = 'block';
    });

    socket.on('game:sessionEnded', () => {
      localStorage.removeItem('hostPin');
      currentPin = '';
      playersData = [];
      location.reload(); // Simplest way to reset everything for host
    });

    window.endSession = () => {
      if (confirm('Tem certeza que deseja encerrar a sess√£o atual? Todos os jogadores ser√£o desconectados.')) {
        socket.emit('host:endSession', { pin: currentPin });
      }
    };

    socket.on('host:reconnected', ({ pin, players, currentQuestion, totalQuestions, answerCount, ranking, questionData, allQuestions: qs, isRestored, questionActive }) => {
      currentPin = pin;
      allQuestions = qs || [];
      updatePersistentLink(pin);
      document.getElementById('control-panel').style.display = 'block';

      // Reconstruct simple player data from list if only names sent, or request full data if needed.
      playersData = ranking.map(p => ({ ...p, answered: false }));

      // Update question index display if possible
      const nextQ = currentQuestion + 1;
      // We can update the UI elements hidden or not
      document.getElementById('q-index').textContent = nextQ;

      if (currentQuestion < 0 && !isRestored) {
        setupLobby(pin);
        updateLobbyPlayers(playersData); // Use playersData for richer info if available
        showScreen('lobby');
      } else if (questionData && questionActive) {
        // Active Question (Timer running)
        showScreen('question');
        document.getElementById('q-index').textContent = currentQuestion + 1;
        document.getElementById('q-total').textContent = totalQuestions;
        document.getElementById('q-text').textContent = questionData.question;
        renderLiveRanking();
        renderUpcomingQuestions(currentQuestion);
      } else {
        // Restored state OR Ranking phase (Timer ended)
        showScreen('ranking');
        renderRanking('ranking-list', ranking);
        // If we are in ranking, we technically finished 'currentQuestion', so next visual index is +1
        // But for upcoming list, we want to show 'currentQuestion' as done.
        renderUpcomingQuestions(currentQuestion + 1, 'upcoming-list-ranking');
      }
    });

    window.forceNext = () => {
      socket.emit('host:next', { pin: currentPin });
    };

    // ... rest of code ...

    function renderUpcomingQuestions(currentIndex, listId = 'upcoming-list') {
      const listEl = document.getElementById(listId);
      if (!listEl) return;
      if (!allQuestions || allQuestions.length === 0) return;

      listEl.innerHTML = allQuestions.map((q, i) => {
        let style = "padding:10px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; gap:10px;";
        let status = "";

        if (i < currentIndex) {
          style += "opacity: 0.5; text-decoration: line-through;";
          status = "‚úì";
        } else if (i === currentIndex) {
          style += "background: rgba(255, 215, 0, 0.1); border-left: 3px solid #ffd700;";
          status = "‚ñ∂";
        } else {
          style += "opacity: 0.8;";
          status = `${i + 1}`;
        }

        return `
          <div style="${style}">
            <div style="font-weight:900; color:#ffd700; width:20px; text-align:center;">${status}</div>
            <div style="font-size:0.9rem; color:#fff;">${q.question}</div>
          </div>
        `;
      }).join('');
    }

    function setupLobby(pin) {
      document.getElementById('pin').textContent = pin;
      document.getElementById('display-link').href = `${window.location.origin}/display.html?pin=${pin}`;

      renderLobbyQuestions();
    }

    function renderLobbyQuestions() {
      const listEl = document.getElementById('lobby-questions-list');
      if (!listEl) return;
      if (!allQuestions || allQuestions.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#aaa;">Nenhuma pergunta carregada.</p>';
        return;
      }

      listEl.innerHTML = allQuestions.map((q, i) => `
        <div style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; gap:15px; align-items:start;">
          <div style="font-weight:900; color:#ffd700; font-size:1rem; min-width:25px;">${i + 1}.</div>
          <div style="flex:1;">
            <div style="font-weight:700; color:#fff; font-size:1rem; margin-bottom:5px;">${q.question}</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
              ${q.options.map((opt, optI) => `
                <div style="font-size:0.8rem; padding:4px 8px; border-radius:4px; background:${optI === q.correct ? 'rgba(46, 204, 113, 0.2)' : 'rgba(255,255,255,0.05)'}; border:1px solid ${optI === q.correct ? '#2ecc71' : 'transparent'}; color:${optI === q.correct ? '#2ecc71' : '#aaa'};">
                  ${opt}
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateLobbyPlayers(players) {
      // players is now an array of objects { name, score, connected }
      // sort by connected (true first) then name
      const sorted = [...players].sort((a, b) => {
        if (a.connected === b.connected) return a.name.localeCompare(b.name);
        return b.connected - a.connected;
      });

      document.getElementById('players').innerHTML = sorted
        .map(p => `
            <div class="player-tag" style="${p.connected ? '' : 'opacity: 0.5; background: #333; border-color: #555;'}">
                ${p.name}${p.connected ? '' : ' (off)'}
                <button class="kick-btn" onclick="kickPlayer('${p.name}')" title="Remover jogador">√ó</button>
            </div>
        `)
        .join('');

      const connectedCount = players.filter(p => p.connected).length;
      document.getElementById('btn-start').disabled = connectedCount === 0;
    }

    window.kickPlayer = (name) => {
      if (confirm(`Tem certeza que deseja remover ${name}?`)) {
        socket.emit('host:kick', { pin: currentPin, name });
      }
    };

    socket.on('host:playersUpdate', ({ players }) => {
      // Update global data
      playersData = players.map(p => {
        // preserve answered state from existing data if possible, or we need to sync it.
        // The server update doesn't include 'answered' state for the current question.
        // We should merge it.
        const existing = playersData.find(old => old.name === p.name);
        return {
          ...p,
          answered: existing ? existing.answered : false
        };
      });

      updateLobbyPlayers(players);
      renderLiveRanking();
    });

    // Remove old host:playerJoined if it exists or keep it for backward compat? 
    // I replaced the server emission, so I should remove the old listener or just let it be unused.
    // But I must ensure I don't have duplicate logic.
    // The previous listener was: socket.on('host:playerJoined', ...)
    // I will replace it.

    socket.on('host:answerCount', ({ count, total }) => {
      // This event is triggered when someone answers.
      // Ideally we'd know WHO answered to update the UI specifically for them.
      // Since we don't have that in this specific event payload currently, 
      // we might need to modify server.js or just refresh the list.
      // But wait, the user wants to see "people answering". 
      // WITHOUT modifying server.js again to send WHO answered in 'host:answerCount', 
      // we can't show *exactly* who answered in real-time on this specific event.
      // HOWEVER, we can infer or ask to update server.js.
      // Given I can only edit files I see, and I just edited server.js, I should probably have added that.
      // BUT, let's see if we can get away with just showing the count?
      // "remove this x respostas and x jogadores and put that [ranking]"
      // If I show the ranking, I need to know who answered to mark them.

      // Let's assume for a "Real Time" experience, we want to show the list.
      // I will add a request to `host:reconnect` style data or just assume we need to
      // trigger a refresh. But `host:answerCount` is small.

      // Actually, I'll modify server.js slightly to send the `sessionId` or `playerName` of the person who answered
      // in the `host:answerCount` event or a new event.
      // Let's do that in a separate tool call if needed, but I'll try to do it here if I can? 
      // No, I need to edit server.js to send 'who' answered.
      // Since I can't edit server.js in this turn (I already did my edits for the previous turn, wait, I can edit multiple files).

      // I will proceed with updating host.html first, then I'll update server.js to send the player name.
    });

    // Listening for a new event I will add to server.js
    socket.on('host:playerAnswered', ({ playerName }) => {
      const player = playersData.find(p => p.name === playerName);
      if (player) {
        player.answered = true;
        renderLiveRanking();
      }
    });

    socket.on('game:question', ({ index, total, question, options }) => {
      showScreen('question');
      document.getElementById('q-index').textContent = index + 1;
      document.getElementById('q-total').textContent = total;
      document.getElementById('q-text').textContent = question;

      // Reset answered status
      playersData.forEach(p => p.answered = false);
      renderLiveRanking();
      renderUpcomingQuestions(index);
    });

    socket.on('game:ranking', ({ ranking }) => {
      // Update scores
      playersData = ranking.map(p => ({ ...p, answered: false }));
      showScreen('ranking');
      renderRanking('ranking-list', ranking);

      // We are in ranking state, meaning current question is done.
      // We want to show the NEXT question as active/upcoming or just mark current as done.
      // If we use current index + 1 as "current" for visualization, it highlights the next one.
      // Let's find current index based on completed questions or state?
      // server doesn't send currentQuestion index in game:ranking.
      // But we have a local tracker if we want, or we can assume it increments.
      // However, server state is authoritative.
      // Let's rely on what we last knew: document.getElementById('q-index').textContent - 1

      const lastIndex = parseInt(document.getElementById('q-index').textContent || "0") - 1;
      const nextIndex = lastIndex + 1;
      renderUpcomingQuestions(nextIndex, 'upcoming-list-ranking');
    });

    socket.on('game:final', ({ ranking }) => {
      showScreen('final');
      renderRanking('final-ranking', ranking);
      localStorage.removeItem('hostPin');
    });

    function renderLiveRanking() {
      // Sort by score (desc)
      const sorted = [...playersData].sort((a, b) => b.score - a.score);

      document.getElementById('live-ranking-list').innerHTML = sorted
        .map((p, i) => `
          <li class="ranking-item ${p.answered ? 'answered' : ''} ${!p.connected ? 'disconnected' : ''}">
            <span class="ranking-position">${i + 1}¬∫</span>
            <span class="ranking-name">${p.name} ${!p.connected ? '(off)' : ''}</span>
            <span class="ranking-score">${p.score}</span>
            <span class="answered-indicator">‚úì</span>
            <button class="kick-btn" style="margin-left:10px;" onclick="kickPlayer('${p.name}')" title="Remover">√ó</button>
          </li>
        `).join('');
    }

    function renderRanking(elementId, ranking) {
      document.getElementById(elementId).innerHTML = ranking
        .map((p, i) => `
          <li class="ranking-item">
            <span class="ranking-position">${i + 1}¬∫</span>
            <span class="ranking-name">${p.name}</span>
            <span class="ranking-score">${p.score}</span>
          </li>
        `).join('');
    }

    function showScreen(screen) {
      $setup.classList.add('hidden'); // Ensure setup is hidden
      $lobby.classList.add('hidden');
      $question.classList.add('hidden');
      $ranking.classList.add('hidden');
      $final.classList.add('hidden');
      document.getElementById(screen).classList.remove('hidden');
    }

    document.getElementById('btn-start').onclick = () => {
      socket.emit('host:start', { pin: currentPin });
    };



    document.getElementById('btn-continue').onclick = () => {
      socket.emit('host:nextQuestion', { pin: currentPin });
    };
  </script>
</body>

</html>