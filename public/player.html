<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Quiz - Jogar</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;900&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(180deg, #0a1628 0%, #1a2a4a 50%, #0a1628 100%);
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(50, 100, 180, 0.15) 1px, transparent 1px),
        linear-gradient(90deg, rgba(50, 100, 180, 0.15) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 100%;
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 30px;
      color: #ffd700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      font-weight: 900;
    }

    .card {
      background: rgba(10, 22, 40, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      width: 100%;
    }

    .hidden {
      display: none !important;
    }

    /* Inputs */
    .input-group {
      margin-bottom: 25px;
    }

    .input-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: 700;
      color: #ffd700;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .input-group input {
      width: 100%;
      padding: 18px;
      font-size: 1.2rem;
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.4);
      border-radius: 12px;
      color: #fff;
      outline: none;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      transition: all 0.2s;
    }

    .input-group input:focus {
      border-color: #ffd700;
      background: rgba(0, 0, 0, 0.6);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
    }

    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 20px;
      font-size: 1.3rem;
      font-weight: 900;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      text-transform: uppercase;
      font-family: 'Montserrat', sans-serif;
      margin-top: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .btn:active {
      transform: scale(0.98);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .btn-primary {
      background: linear-gradient(180deg, #ffd700 0%, #c9a800 100%);
      color: #8b0000;
      border: 1px solid #ffd700;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.4);
    }

    /* Options Grid - Mobile Friendly */
    .options-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
    }

    .option-btn {
      width: 100%;
      background: linear-gradient(180deg, #c41e3a 0%, #8b0000 100%);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 16px;
      padding: 25px 20px;
      min-height: 90px;
      display: flex;
      align-items: center;
      gap: 20px;
      cursor: pointer;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      -webkit-tap-highlight-color: transparent;
    }

    .option-btn:active {
      transform: scale(0.97);
      background: linear-gradient(180deg, #a01830 0%, #600000 100%);
    }

    .option-btn:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none;
    }

    /* Number circle */
    .option-btn::before {
      content: attr(data-index-display);
      width: 44px;
      height: 44px;
      background: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 900;
      color: #0a1628;
      flex-shrink: 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    .option-text {
      color: #fff;
      font-size: 1.3rem;
      font-weight: 700;
      text-align: left;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
      flex: 1;
      line-height: 1.3;
    }

    /* Question text on player screen */
    .question-display {
      background: transparent;
      padding: 0 0 25px;
      text-align: center;
    }

    .question-header {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9rem;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .question-text {
      font-size: 1.5rem;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      line-height: 1.4;
    }

    /* Waiting & Feedback */
    .waiting {
      text-align: center;
      padding: 40px 20px;
    }

    .feedback {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .waiting-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      margin-top: 25px;
      line-height: 1.5;
    }

    .spinner {
      width: 70px;
      height: 70px;
      border: 6px solid rgba(255, 255, 255, 0.1);
      border-top-color: #ffd700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .feedback-icon {
      font-size: 6rem;
      margin-bottom: 20px;
      text-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
      font-weight: 900;
    }

    .feedback-correct {
      color: #2ecc71;
      text-shadow: 0 0 30px rgba(46, 204, 113, 0.4);
    }

    .feedback-wrong {
      color: #e74c3c;
      text-shadow: 0 0 30px rgba(231, 76, 60, 0.4);
    }

    /* Ranking Item */
    .ranking-list {
      list-style: none;
    }

    .ranking-item {
      background: linear-gradient(180deg, #2a5a9a 0%, #1a3a6a 100%);
      border: 3px solid #5aafff;
      border-radius: 14px;
      padding: 18px 20px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .ranking-position {
      font-size: 1.5rem;
      font-weight: 900;
      width: 40px;
      color: #fff;
    }

    .ranking-name {
      font-weight: 700;
      font-size: 1.2rem;
      flex: 1;
      color: #fff;
    }

    .ranking-score {
      font-weight: 900;
      color: #ffd700;
      font-size: 1.3rem;
    }

    /* Your Position Big Display */
    .your-position {
      background: linear-gradient(180deg, #ffd700 0%, #c9a800 100%);
      padding: 30px;
      border-radius: 16px;
      text-align: center;
      margin-bottom: 30px;
      color: #8b0000;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
      border: 2px solid #fff;
    }

    .your-position p {
      font-weight: 700;
      text-transform: uppercase;
      font-size: 1rem;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .your-position-number {
      font-size: 5rem;
      font-weight: 900;
      line-height: 1;
      text-shadow: 0 2px 0 rgba(255, 255, 255, 0.4);
    }

    /* Answer Counter */
    .answer-count {
      position: fixed;
      top: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.9rem;
      font-weight: 700;
      color: #fff;
      z-index: 100;
    }

    .answer-count span {
      color: #ffd700;
    }

    /* Timer Bar */
    .timer-bar-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      z-index: 200;
    }

    .timer-bar {
      height: 100%;
      background: #ffd700;
      width: 100%;
      transition: width 1s linear;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
  </style>
</head>

<body>
  <div id="timer-bar-container" class="timer-bar-container hidden">
    <div id="timer-bar" class="timer-bar"></div>
  </div>
  <div id="answer-counter" class="answer-count hidden">
    <span id="answered-val">0</span>/<span id="total-val">0</span>
  </div>
  <div class="container">
    <h1 id="main-title">Quiz Show</h1>

    <!-- Join -->
    <div id="join" class="card">
      <div id="join-form">
        <div class="input-group">
          <label>PIN da Sala</label>
          <input type="text" id="input-pin" placeholder="0000" maxlength="4" inputmode="numeric" pattern="[0-9]*">
        </div>
        <div class="input-group">
          <label>Seu Nome</label>
          <input type="text" id="input-name" placeholder="Digite seu nome" maxlength="20">
        </div>
        <button class="btn btn-primary" id="btn-join">Entrar</button>
        <button class="btn" id="btn-reconnect-mode"
          style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); font-size:1rem; margin-top:20px;">
          Reconectar Jogador Antigo
        </button>
      </div>

      <div id="reconnect-form" class="hidden">
        <h3 style="text-align:center; color:#ffd700; margin-bottom:20px;">Reconectar</h3>
        <div class="input-group">
          <label>PIN da Sala</label>
          <input type="text" id="reconnect-pin" placeholder="0000" maxlength="4" inputmode="numeric" pattern="[0-9]*">
        </div>
        <button class="btn btn-primary" id="btn-find-profiles">Buscar Perfil</button>
        <button class="btn" id="btn-cancel-reconnect"
          style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); font-size:1rem; margin-top:15px;">
          Cancelar
        </button>
      </div>

      <div id="profile-select" class="hidden">
        <h3 style="text-align:center; color:#ffd700; margin-bottom:20px;">Selecione seu Perfil</h3>
        <div id="profiles-list"
          style="max-height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;"></div>
        <button class="btn" id="btn-cancel-select"
          style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); font-size:1rem; margin-top:15px;">
          Voltar
        </button>
      </div>

      <p id="error"
        style="color:#ff6b6b;text-align:center;margin-top:20px;font-weight:700;background:rgba(0,0,0,0.3);padding:10px;border-radius:8px;display:none;">
      </p>
    </div>

    <!-- Waiting -->
    <div id="waiting" class="card hidden">
      <div class="waiting">
        <div class="spinner"></div>
        <p class="waiting-text">Aguardando o host iniciar...</p>
        <div
          style="margin-top:30px; background:rgba(255,255,255,0.1); padding:15px; border-radius:12px; border: 1px solid rgba(255,255,255,0.2);">
          <small style="color:#aaa; text-transform: uppercase; font-size: 0.8rem;">Você entrou como</small>
          <p style="font-size:1.8rem;font-weight:900;color:#5aafff;margin-top:5px;" id="player-name"></p>
        </div>
      </div>
    </div>

    <!-- Question -->
    <div id="question" class="hidden" style="width:100%">
      <div style="text-align:center; margin-bottom:15px;">
        <img src="/assets/logo.jpg" alt="Kine Show do Milhão" style="max-width:200px; height:auto;">
      </div>
      <div class="question-display">
        <p class="question-header">Pergunta <span id="q-index">1</span>/<span id="q-total">5</span></p>
        <p class="question-text" id="q-text"></p>
      </div>

      <div class="options-grid" id="q-options"></div>
    </div>

    <!-- Feedback -->
    <div id="feedback" class="card hidden">
      <div class="feedback">
        <div class="feedback-icon" id="feedback-icon"></div>
        <p class="waiting-text" id="feedback-text"></p>
        <div class="spinner" style="margin-top:40px; width:40px; height:40px; border-width:4px;"></div>
        <p style="margin-top:15px;color:rgba(255,255,255,0.6);font-size:0.9rem;">Aguardando ranking...</p>
      </div>
    </div>

    <!-- Ranking -->
    <div id="ranking" class="card hidden">
      <h2
        style="text-align:center;margin-bottom:25px;color:#ffd700;font-size:2rem;text-shadow:0 0 10px rgba(255,215,0,0.5);">
        Ranking</h2>
      <ul class="ranking-list" id="ranking-list"></ul>
      <div class="waiting" style="padding:20px 0;">
        <div class="spinner" style="width:40px;height:40px;border-width:4px;"></div>
        <p class="waiting-text" style="font-size:1rem;">Aguardando próxima pergunta...</p>
      </div>
    </div>

    <!-- Final -->
    <div id="final" class="card hidden">
      <h2
        style="text-align:center;margin-bottom:30px;font-size:2.5rem;color:#ffd700;text-shadow:0 0 20px rgba(255,215,0,0.6);">
        Fim do Quiz!</h2>
      <div class="your-position">
        <p>Sua posição</p>
        <div class="your-position-number" id="your-position">-</div>
      </div>
      <ul class="ranking-list" id="final-ranking"></ul>
    </div>
  </div>

  <script>
    const socket = io();
    let currentPin = '';
    let myName = '';
    let sessionId = '';

    const $join = document.getElementById('join');
    const $waiting = document.getElementById('waiting');
    const $question = document.getElementById('question');
    const $feedback = document.getElementById('feedback');
    const $ranking = document.getElementById('ranking');
    const $final = document.getElementById('final');
    const $mainTitle = document.getElementById('main-title');
    const $answerCounter = document.getElementById('answer-counter');
    const $timerContainer = document.getElementById('timer-bar-container');
    const $timerBar = document.getElementById('timer-bar');
    let timerInterval = null;

    const urlParams = new URLSearchParams(window.location.search);
    const pinFromUrl = urlParams.get('pin');
    if (pinFromUrl) {
      document.getElementById('input-pin').value = pinFromUrl;
    }

    socket.on('connect', () => {
      // Automatic reconnection on socket restore
      const savedSession = localStorage.getItem('quizSession');
      if (savedSession) {
        const session = JSON.parse(savedSession);
        // If we are already logged in (sessionId set locally), or if we are restoring state
        if (session && session.sessionId) {
          console.log('Restoring session on connect:', session.sessionId);
          socket.emit('player:reconnect', { sessionId: session.sessionId });
        }
      }
    });

    // Remove the immediate execution logic since 'connect' will handle it
    // const savedSession = localStorage.getItem('quizSession');
    // if (savedSession) { ... }

    socket.on('player:error', (msg) => {
      localStorage.removeItem('quizSession');
      const errEl = document.getElementById('error');
      errEl.textContent = msg;
      errEl.style.display = 'block';
      showScreen('join');
    });

    socket.on('game:sessionEnded', () => {
      alert('A sessão foi encerrada pelo host.');
      localStorage.removeItem('quizSession');
      location.reload();
    });

    socket.on('player:joined', ({ name, sessionId: sid }) => {
      myName = name;
      sessionId = sid;
      currentPin = document.getElementById('input-pin').value.trim();
      localStorage.setItem('quizSession', JSON.stringify({ sessionId: sid, pin: currentPin, name }));
      document.getElementById('player-name').textContent = name;
      showScreen('waiting');
    });

    socket.on('player:reconnected', ({ name, score, gameStarted, hasAnswered, isRestored }) => {
      const session = JSON.parse(localStorage.getItem('quizSession'));
      myName = name;
      sessionId = session.sessionId;
      currentPin = session.pin;
      document.getElementById('player-name').textContent = name;

      if (isRestored) {
        // Game restored, show ranking waiting screen
        showScreen('ranking');
        // We might not have full ranking data here unless server sends it on player:reconnect too.
        // Usually player:reconnect sends simpler data.
        // Let's check if we can get ranking or just show "Waiting for next question" generic screen.
        // The server currently sends: name, score, gameStarted, currentQuestion, hasAnswered.
        // It does NOT send the full ranking list to individual players on reconnect (to save bandwidth?).
        // But for "Show do Milhão" style, maybe we should?
        // For now, let's just show the waiting/spinner in ranking div.
        document.getElementById('ranking-list').innerHTML = ''; // Clear old ranking
        document.querySelector('#ranking .waiting-text').textContent = 'Aguardando próxima pergunta...';
      } else if (!gameStarted) {
        showScreen('waiting');
      } else if (hasAnswered) {
        showScreen('feedback');
        document.getElementById('feedback-icon').textContent = '...';
        document.getElementById('feedback-icon').className = 'feedback-icon';
        document.getElementById('feedback-text').textContent = 'Reconectado! Aguardando...';
      }
    });

    socket.on('game:question', ({ index, total, question, options, timeLimit }) => {
      showScreen('question');
      document.getElementById('q-index').textContent = index + 1;
      document.getElementById('q-total').textContent = total;
      document.getElementById('q-text').textContent = question;

      startTimer(timeLimit);

      const $options = document.getElementById('q-options');
      $options.innerHTML = options
        .map((opt, i) => `
          <button class="option-btn" data-index="${i}" data-index-display="${i + 1}">
            <span class="option-text">${opt}</span>
          </button>
        `)
        .join('');

      $options.querySelectorAll('button').forEach(btn => {
        btn.onclick = () => {
          const answer = parseInt(btn.dataset.index);
          socket.emit('player:answer', { pin: currentPin, answer });

          // Disable all buttons immediately for feedback
          $options.querySelectorAll('button').forEach(b => {
            b.disabled = true;
            b.style.opacity = '0.5';
          });
          btn.style.opacity = '1';
          btn.style.border = '2px solid #fff';
          btn.style.background = '#ffd700'; // Gold highlight
          btn.querySelector('.option-text').style.color = '#000'; // Dark text on gold
          // Reset inner circle
          const circle = window.getComputedStyle(btn, '::before');
          // Can't style pseudo-elements easily inline, but the color change is enough
        };
      });
    });

    socket.on('player:answered', () => {
      showScreen('feedback');
      document.getElementById('feedback-icon').textContent = '...';
      document.getElementById('feedback-icon').className = 'feedback-icon';
      document.getElementById('feedback-text').textContent = 'Aguardando outros jogadores...';
    });

    socket.on('player:feedback', ({ correct, points, timeUp }) => {
      const $icon = document.getElementById('feedback-icon');
      const $text = document.getElementById('feedback-text');

      // If user was on question screen (didn't answer), move to feedback screen
      showScreen('feedback');

      if (timeUp) {
        $icon.textContent = '⏰';
        $icon.className = 'feedback-icon feedback-wrong';
        $text.innerHTML = `Tempo Esgotado!<br><span style="font-size:1.2rem;color:#aaa;display:block;margin-top:10px;">+0 pts</span>`;
      } else if (correct) {
        $icon.textContent = '✓';
        $icon.className = 'feedback-icon feedback-correct';
        $text.innerHTML = `Correto!<br><span style="font-size:1.5rem;color:#ffd700;display:block;margin-top:10px;">+${points} pts</span>`;
      } else {
        $icon.textContent = '✗';
        $icon.className = 'feedback-icon feedback-wrong';
        $text.textContent = 'Errado!';
      }
    });

    socket.on('game:answerCount', ({ count, total }) => {
      document.getElementById('answered-val').textContent = count;
      document.getElementById('total-val').textContent = total;
    });

    socket.on('game:ranking', ({ ranking }) => {
      showScreen('ranking');
      renderRanking('ranking-list', ranking);
    });

    socket.on('game:final', ({ ranking }) => {
      showScreen('final');
      renderRanking('final-ranking', ranking);
      localStorage.removeItem('quizSession');

      const myPosition = ranking.findIndex(p => p.name === myName) + 1;
      document.getElementById('your-position').textContent = myPosition > 0 ? `${myPosition}º` : '-';
    });

    function renderRanking(elementId, ranking) {
      document.getElementById(elementId).innerHTML = ranking
        .map((p, i) => `
          <li class="ranking-item" ${p.name === myName ? 'style="border-color:#ffd700; background:linear-gradient(180deg, #ffd700 0%, #c9a800 100%);"' : ''}>
            <span class="ranking-position" ${p.name === myName ? 'style="color:#8b0000;"' : ''}>${i + 1}º</span>
            <span class="ranking-name" ${p.name === myName ? 'style="color:#8b0000;"' : ''}>${p.name}</span>
            <span class="ranking-score" ${p.name === myName ? 'style="color:#8b0000;"' : ''}>${p.score}</span>
          </li>
        `).join('');
    }

    function showScreen(screen) {
      // Hide main title on game screens to save space
      if (screen === 'question' || screen === 'feedback' || screen === 'ranking') {
        $mainTitle.classList.add('hidden');
      } else {
        $mainTitle.classList.remove('hidden');
      }

      // Show/Hide answer counter
      if (screen === 'question' || screen === 'feedback') {
        $answerCounter.classList.remove('hidden');
      } else {
        $answerCounter.classList.add('hidden');
      }

      // Timer bar visibility
      if (screen === 'question') {
        $timerContainer.classList.remove('hidden');
      } else {
        $timerContainer.classList.add('hidden');
        if (timerInterval) clearInterval(timerInterval);
      }

      $join.classList.add('hidden');
      $waiting.classList.add('hidden');
      $question.classList.add('hidden');
      $feedback.classList.add('hidden');
      $ranking.classList.add('hidden');
      $final.classList.add('hidden');
      document.getElementById(screen).classList.remove('hidden');
    }

    function startTimer(seconds) {
      if (timerInterval) clearInterval(timerInterval);

      const totalTime = seconds * 1000;
      const startTime = Date.now();

      // Reset bar
      $timerBar.style.transition = 'none';
      $timerBar.style.width = '100%';

      // Force reflow
      $timerBar.offsetHeight;

      // Start animation
      $timerBar.style.transition = `width ${seconds}s linear`;
      $timerBar.style.width = '0%';

      // Just for cleanup, though CSS handles the visual
      timerInterval = setTimeout(() => {
        // Time up logic handled by server events mostly
      }, totalTime);
    }

    document.getElementById('btn-join').onclick = () => {
      const pin = document.getElementById('input-pin').value.trim();
      const name = document.getElementById('input-name').value.trim();

      if (!pin || !name) {
        const errEl = document.getElementById('error');
        errEl.textContent = 'Preencha todos os campos';
        errEl.style.display = 'block';
        return;
      }

      currentPin = pin;
      document.getElementById('error').style.display = 'none';
      socket.emit('player:join', { pin, name });
    };

    document.getElementById('input-name').onkeypress = (e) => {
      if (e.key === 'Enter') document.getElementById('btn-join').click();
    };

    // Reconnection Flow
    const $joinForm = document.getElementById('join-form');
    const $reconnectForm = document.getElementById('reconnect-form');
    const $profileSelect = document.getElementById('profile-select');

    document.getElementById('btn-reconnect-mode').onclick = () => {
      $joinForm.classList.add('hidden');
      $reconnectForm.classList.remove('hidden');
      document.getElementById('error').style.display = 'none';
    };

    document.getElementById('btn-cancel-reconnect').onclick = () => {
      $reconnectForm.classList.add('hidden');
      $joinForm.classList.remove('hidden');
      document.getElementById('error').style.display = 'none';
    };

    document.getElementById('btn-cancel-select').onclick = () => {
      $profileSelect.classList.add('hidden');
      $reconnectForm.classList.remove('hidden');
    };

    document.getElementById('btn-find-profiles').onclick = () => {
      const pin = document.getElementById('reconnect-pin').value.trim();
      if (!pin) {
        showError('Digite o PIN da sala');
        return;
      }
      currentPin = pin; // Store for later join
      socket.emit('player:getDisconnectedProfiles', { pin });
    };

    socket.on('player:disconnectedProfiles', (profiles) => {
      if (profiles.length === 0) {
        showError('Nenhum perfil desconectado encontrado nesta sala.');
        return;
      }

      $reconnectForm.classList.add('hidden');
      $profileSelect.classList.remove('hidden');
      document.getElementById('error').style.display = 'none';

      const list = document.getElementById('profiles-list');
      list.innerHTML = profiles.map(p => `
        <button class="btn" style="text-align:left; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(180deg, #2a5a9a 0%, #1a3a6a 100%); border-color:#5aafff;"
          onclick="reconnectAs('${p.name}')">
          <span>${p.name}</span>
          <span style="color:#ffd700; font-weight:900;">${p.score} pts</span>
        </button>
      `).join('');
    });

    window.reconnectAs = (name) => {
      // Use standard join, server handles reclaiming logic now
      socket.emit('player:join', { pin: currentPin, name });
    };

    function showError(msg) {
      const errEl = document.getElementById('error');
      errEl.textContent = msg;
      errEl.style.display = 'block';
    }
  </script>
</body>

</html>